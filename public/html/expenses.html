<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Expense Tracker</title>
    <link rel="stylesheet" href="/css/expenses.css" />
    <link rel="stylesheet" href="/css/expenseTable.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-dark">
    <div class="row bg-light">
      <div class="col text-start mt-2 ms-1 py-1">
        <h6><i>Welcome to Expense Tracker !!!</i></h6>
      </div>
      <div class="col text-center mt-1 py-1">
        <button
          id="leaderboardBtn"
          class="btn btn-success btn-sm"
          style="display: none"
          onclick="showLeaderboard(event)"
        >
          SHOW LEADERBOARD
        </button>
      </div>
      <div class="col text-end me-1 py-1">
        <button
          id="premiumBtn"
          class="btn btn-primary"
          onclick="premiumHandler(event)"
        >
          GO PREMIUM
        </button>
      </div>
    </div>
    <div style="border: none; background-color: black; height: 1px"></div>

    <div class="container">
      <form id="form" class="form">
        <div class="row">
          <div class="col-4">
            <label for="expense" class="form-label">Expense Amount</label>
            <input id="expense" type="number" class="form-control" required />
          </div>
          <div class="col-4">
            <label for="description" class="form-label">Description</label>
            <input id="description" type="text" class="form-control" required />
          </div>
          <div class="col-4">
            <label for="category" class="form-label">Category</label>
            <select id="category" class="form-select">
              <option value="" required disabled selected>Select</option>
              <option value="FOOD">FOOD</option>
              <option value="FUEL">FUEL</option>
              <option value="GROCERIES">GROCERIES</option>
              <option value="TRAVEL">TRAVEL</option>
              <option value="INCOME">INCOME</option>
            </select>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-12">
            <button type="submit" class="btn btn-dark">ADD EXPENSE</button>
          </div>
        </div>
      </form>
      <div id="expensesDiv" class="container form1" style="display: none">
        <h5>EXPENSES</h5>
        <label class="form-label">Rows per page:</label>
        <select id="expRows">
          <option value="" required disabled selected>-</option>
          <option value="5">5</option>
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
        <ul id="expenses"></ul>
        <div class="expPagination" id="expPagination"></div>
      </div>
      <div id="leaderboardDiv" class="container form1" style="display: none">
        <h5>LEADERBOARD</h5>
        <ul id="leaderboard"></ul>
      </div>      
    </div>
    <div class="row mx-4 bigDivs">
      <div class="col-6">
        <div id="expensesTableDiv" class="container form1" style="display: none">
          <h5>EXPENSE-INCOME TABLE</h5>
          <div class="row d-flex flex-row justify-content-center align-items-center">
            <button class="downloadBtn" onclick="downloadExpenses(event)">
              <img id="premiumFeatures" style="display: none !important;" src='./download icon.png' alt='download icon'/>
            </button>
            <div class="col-12">
              <button id="refreshBtn" class="btn btn-primary">Refresh</button>
            </div>
          </div>
          <table id="expensesTable" class="table table-bordered">
            <h5>Expense Table</h5>
            <thead>
              <tr>
                <th class="col-4">Description</th>
                <th class="col-4">Category</th>
                <th class="col-4">Amount</th>
              </tr>
            </thead>
            <tbody id="expensesBody"></tbody>
          </table>
          <table id="incomeTable" class="table table-bordered">
            <h5>Income Table</h5>
            <thead>
              <tr>
                <th class="col-4">Description</th>
                <th class="col-4">Category</th>
                <th class="col-4">Amount</th>
              </tr>
            </thead>
            <tbody id="incomeBody"></tbody>
          </table>
        </div>
      </div>
      <div class="col-6">
        <div id="downloadsDiv" class="container form1">
          <table id="downloadsTable" class="table table-bordered">
            <h5>DOWNLOADS</h5>
            <div class="col-12">
              <button id="refreshDownloadsBtn" class="btn btn-primary">Refresh</button>
            </div>
            <div class="col-12 d-flex flex-row align-items-center justify-content-center">
              <label class="form-label" style="display: inline;">Rows per page:</label>
              <select id="dwnRows">
                <option value="" required disabled selected>-</option>
                <option value="3">3</option>
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
              </select>
            </div>
            <thead>
              <tr>
                <th class="col-4">Link</th>
                <th class="col-4">Date</th>
              </tr>
            </thead>
            <tbody id="downloadsBody"></tbody>
          </table>
          <div class="pagination" id="pagination"></div>
        </div>
      </div>
    </div>
    
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
    <script>
      let downloadsCurrentPage = 1;
      let expCurrentPage = 1;
      const pagination = document.getElementById('pagination');
      const expPagination = document.getElementById('expPagination');

      const isPremium = localStorage.getItem("isPremium");
      if (isPremium!=='null') {
        document.getElementById("premiumBtn").textContent =
          "You are a Premium User";
        document.getElementById("premiumBtn").onclick = null;
        document.getElementById("premiumBtn").style.cursor = "not-allowed";
        document.getElementById("leaderboardBtn").style.display = "inline";
        document.getElementById("premiumFeatures").style.display = "block";
      }

      const form = document.querySelector("#form");
      const expenseamtInp = document.querySelector("#expense");
      const descriptionInp = document.querySelector("#description");
      const categoryInp = document.querySelector("#category");

      const expenseList = document.querySelector("#expenses");
      const leaderboardList = document.querySelector("#leaderboard");

      form.addEventListener("submit", addItem);
      async function addItem(e) {
        e.preventDefault();
        if (
          expenseamtInp.value === "" ||
          descriptionInp.value === "" ||
          categoryInp.value === ""
        ) {
          alert("Fill all inputs!");
        } else {
          let amount = expenseamtInp.value;
          let description = descriptionInp.value;
          let category = categoryInp.value;
          let obj = {
            amount,
            description,
            category,
          };
          const token = localStorage.getItem("token");
          try {
            const response = await axios.post(
              "http://localhost:3000/expenses/addExpense",
              obj,
              {
                headers: { 'Authorization': token },
              }
            );
            showExpense(response.data.newExpense);
            document.getElementById("leaderboardDiv").style.display = "none";
            if (expenseList.childElementCount > 0) {
              document.getElementById("expensesDiv").style.display = "block";
              document.getElementById("expensesTableDiv").style.display = "block";
            }
            expenseamtInp.value = "";
            descriptionInp.value = "";
            categoryInp.value = "";
          } catch (err) {
            console.log(err);
          }
        }
      }

      function showExpense(obj) {
        let newLi = document.createElement("li");
        newLi.className = "item";
        let details = `${obj.amount}-${obj.description}-${obj.category}`;
        newLi.appendChild(document.createTextNode(details));
        let delBtn = document.createElement("button");
        delBtn.className = "deletebtn delete";
        delBtn.appendChild(document.createTextNode("DELETE"));
        newLi.appendChild(delBtn);
        expenseList.appendChild(newLi);
      }

      expenseList.addEventListener("click", deleteItem);
      async function deleteItem(e) {
        if (e.target.classList.contains("delete")) {
          if (confirm('Click on "OK" to Delete Item')) {
            let elementToDelete =
              e.target.parentElement.textContent.split("-")[1];
            const token = localStorage.getItem("token");
            try {
              const response = await axios.get(
                "http://localhost:3000/expenses/getExpenses",
                {
                  headers: { 'Authorization': token },
                }
              );
              for (let i = 0; i < response.data.length; i++) {
                if (response.data[i].description === elementToDelete) {
                  let deletedUser = response.data[i].description;
                  try {
                    await axios.delete(
                      "http://localhost:3000/deleteExpense/" +
                        response.data[i].id
                    );
                    expenseList.removeChild(e.target.parentElement);
                    console.log(deletedUser, "has been removed!");
                    document.getElementById("leaderboardDiv").style.display =
                      "none";
                    if (expenseList.childElementCount === 0) {
                      document.getElementById("expensesDiv").style.display =
                        "none";
                    }
                  } catch (err) {
                    console.log(err);
                  }
                }
              }
            } catch (err) {
              console.log(err);
            }
          }
        }
      }

      async function premiumHandler(e) {
        e.preventDefault();
        const token = localStorage.getItem("token");
        try {
          const response = await axios.get(
            "http://localhost:3000/premium/buyPremium",
            {
              headers: { 'Authorization': token },
            }
          );
          let options = {
            key: response.data.key_id,
            order_id: response.data.order.id,
            handler: async (res) => {
              try {
                const response = await axios.post(
                  "http://localhost:3000/premium/updateStatus",
                  {
                    order_id: options.order_id,
                    payment_id: res.razorpay_payment_id,
                  },
                  { headers: { 'Authorization': token } }
                );
                alert("You are now a Premium User!");
                localStorage.setItem("isPremium", true);
                document.getElementById("premiumBtn").textContent =
                  "You are a Premium User";
                document.getElementById("premiumBtn").onclick = null;
                document.getElementById("premiumBtn").style.cursor =
                  "not-allowed";
                document.getElementById("leaderboardBtn").style.display =
                  "inline";
                document.getElementById("premiumFeatures").style.display = "block";
              } catch (err) {
                alert("Something went wrong. Please retry!");
                const response = await axios.post(
                  "http://localhost:3000/premium/updateStatus",
                  {
                    order_id: options.order_id,
                    payment_id: res.razorpay_payment_id,
                    status: "FAILED",
                  },
                  { headers: { 'Authorization': token } }
                );
                alert("Transaction Failed. Please retry!");
              }
            },
          };
          const razorpayUI = new Razorpay(options);
          razorpayUI.open();
          razorpayUI.on("payment.failed", async (res) => {
            try {
              const response = await axios.post(
                "http://localhost:3000/premium/updateStatus",
                {
                  order_id: options.order_id,
                  payment_id: res.razorpay_payment_id,
                  status: "FAILED",
                },
                { headers: { 'Authorization': token } }
              );
              alert("Transaction Failed. Please retry!");
            } catch (err) {
              alert(err.response.data.message);
            }
          });
        } catch (err) {
          alert("Transaction Failed!");
        }
      }

      async function showLeaderboard(e) {
        const token = localStorage.getItem("token");
        document.getElementById("leaderboardDiv").style.display = "block";
        document.getElementById("leaderboardBtn").textContent =
          "UPDATE LEADERBOARD";
        try {
          const response = await axios.get(
            "http://localhost:3000/premium/showLeaderboard",
            {
              headers: { 'Authorization': token },
            }
          );
          while (leaderboardList.firstChild) {
            leaderboardList.removeChild(leaderboardList.firstChild);
          }
          response.data.response.forEach((expense) => {
            const li = document.createElement("li");
            let total =
              expense.totalExpense === null ? 0 : expense.totalExpense;
            let details = `Name-${expense.name} Total Expense-${total}`;
            li.appendChild(document.createTextNode(details));
            leaderboardList.appendChild(li);
          });
        } catch (err) {
          console.log(err);
        }
      }

      document.addEventListener("DOMContentLoaded", function() {
        const refreshBtn = document.getElementById("refreshBtn");
        const expensesBody = document.getElementById("expensesBody");
        const incomeBody = document.getElementById("incomeBody");

        const refreshDownloadsBtn = document.getElementById("refreshDownloadsBtn");
        const downloadsBody = document.getElementById("downloadsBody");

        document.getElementById('expRows').value=localStorage.getItem('expRows');
        document.getElementById('dwnRows').value=localStorage.getItem('dwnRows');
        
        refreshBtn.addEventListener("click", refreshData);
        function refreshData() {
          fetchExpenses(expCurrentPage);
          fetchExpenses()
          fetchIncome();
        }
        refreshDownloadsBtn.addEventListener("click", refreshDownloads);
        function refreshDownloads() {
          fetchDownloads();
        }
        refreshData();
        refreshDownloads();

        async function fetchExpenses(page) {
          try {
            const token = localStorage.getItem("token");
            const response = await axios.get(
              `http://localhost:3000/expenses/getExpenses`,
              {
                headers: { 'Authorization': token },
              }
            );
            renderExpenses(response.data.response.filter(expense=>expense.category!=='INCOME'));
          } catch (error) {
            console.error("Error fetching expenses:", error);
          }
        }

        async function fetchIncome() {
          try {
            const token = localStorage.getItem("token");
            const response = await axios.get(
              `http://localhost:3000/expenses/getExpenses`,
              {
                headers: { 'Authorization': token },
              }
            );
            renderIncome(response.data.response.filter(expense=>expense.category==='INCOME'));
          } catch (error) {
            console.error("Error fetching income:", error);
          }
        }

        async function fetchDownloads(page){
          try {
            const token = localStorage.getItem("token");
            const response = await axios.get(
              `http://localhost:3000/premium/getDownloads/`,
              {
                headers: { 'Authorization': token },
              }
            );
            return response.data.downloads;
          }catch (error) {
            console.error("Error fetching income:", error);
          }
        }

        async function renderExpenses(data) {
          expensesBody.innerHTML = "";
          if(data.length>0){
            data.forEach(expense => {
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${expense.description}</td>
                <td>${expense.category}</td>
                <td>${expense.amount}</td>
              `;
              expensesBody.appendChild(row);
            });
          }else{
            const row = document.createElement("tr");
            row.innerHTML = `
              <td colspan='3'>No Expenses Yet</td>
            `;
            expensesBody.appendChild(row);
          }
        }

        function renderIncome(data) {
          incomeBody.innerHTML = "";
          if(data.length>0){
            data.forEach(income => {
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${income.description}</td>
                <td>${income.category}</td>
                <td>${income.amount}</td>
              `;
              incomeBody.appendChild(row);
            });
          }else{
            const row = document.createElement("tr");
            row.innerHTML = `
              <td colspan='3'>No Incomes Yet</td>
            `;
            incomeBody.appendChild(row);
          }
        }

        async function generatePagination(url,divName,currPage,loadCategory) {
          divName.innerHTML = '';
          const data = await fetchPageData(url);
          let size;
          if(divName.className==='pagination'){
            size=localStorage.getItem('dwnRows'); 
          }else{
            size=localStorage.getItem('expRows');
          }
          const pageCount = Math.ceil(data.response.length / size);
          for (let i = 1; i <= pageCount; i++) {
            const button = document.createElement('button');
            button.textContent = i;
            button.addEventListener('click', () => {
              if(divName.className==='pagination'){
                downloadsCurrentPage=i;
                currPage = downloadsCurrentPage;
              }else{
                expCurrentPage=i;
                currPage = expCurrentPage;
              }
              updateActiveButton(divName,currPage,loadCategory);
            });
            divName.appendChild(button);
          }
          updateActiveButton(divName,currPage,loadCategory);
        }

        function updateActiveButton(divName,currPage,category) {
          const buttons = divName.querySelectorAll('button');
          buttons.forEach(async(button) => {
            button.classList.remove('active');
            if (parseInt(button.textContent) === currPage) {
              button.classList.add('active');
              category(button.textContent);
            }
          });
        }
        async function fetchPageData(url,page){
          try {
            const token = localStorage.getItem("token");
            const response = await axios.get(
              url,
              {
                headers: { 'Authorization': token },
              }
            );
            return(response.data);
          } catch (error) {
            console.error(error);
          }
        }
        renderDownloads(downloadsCurrentPage);
        generatePagination(`http://localhost:3000/premium/getDownloads`,pagination,downloadsCurrentPage,renderDownloads);
        fetch(expCurrentPage);
        generatePagination(`http://localhost:3000/expenses/getExpenses`,expPagination,expCurrentPage,fetch);

        async function renderDownloads(page) {
          downloadsBody.innerHTML = "";
          const data = await fetchPageData(`http://localhost:3000/premium/getDownloads?page=${page}&pageSize=${localStorage.getItem('dwnRows')}`,page);
          if(data.response.length>0){
            data.response.forEach(download => {
              const row = document.createElement("tr");
              const filenameCell = document.createElement("td");
              row.appendChild(filenameCell);
              const dateCell = document.createElement("td");
              dateCell.textContent = download.filename;
              row.appendChild(dateCell);
              const link = document.createElement('a');
              link.href = download.url;
              link.download = 'myexpenses.csv';
              link.textContent = 'Download';
              filenameCell.appendChild(link);
              downloadsBody.appendChild(row);
            });
          }else{
            const row = document.createElement("tr");
            row.innerHTML = `
              <td colspan='2'>No Downloads Yet</td>
            `;
            downloadsBody.appendChild(row);
          }
        }

        async function fetch() {
          expenseList.innerHTML='';
          const token = localStorage.getItem("token");
          try {
            const response = await axios.get(
              `http://localhost:3000/expenses/getExpenses?page=${expCurrentPage}&pageSize=${localStorage.getItem('expRows')}`,
              {
                headers: { 'Authorization': token },
              }
            );
            for (let i = 0; i < response.data.response.length; i++) {
              showExpense(response.data.response[i]);
              if (expenseList.childElementCount > 0) {
                document.getElementById("expensesDiv").style.display = "block";
                document.getElementById("expensesTableDiv").style.display = "block";
              }
            }
          } catch (err) {
            console.log(err);
          }
        }
    });
      
      async function downloadExpenses(){
        const token=localStorage.getItem('token');
        const response = await axios.get(
          "http://localhost:3000/premium/downloadExpenses",
          {
            headers: { 'Authorization': token },
          }
        );
        if(response.status===200){
          var a=document.createElement('a');
          a.href=response.data.fileURL;
          a.download='myexpense.csv';
          a.click();
        }else{
          throw new Error(response.data.message);
        }
      }

      document.getElementById('expRows').addEventListener('change',function(){
        localStorage.setItem('expRows',this.value);
        if(localStorage.getItem('expRows')>0){
          window.location.reload();
        }
      });

      document.getElementById('dwnRows').addEventListener('change',function(){
        localStorage.setItem('dwnRows',this.value);
        if(localStorage.getItem('dwnRows')>0){
          window.location.reload();
        }
      });

    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
